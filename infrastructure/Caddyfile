{
	# Global options block (optional)
	# Enable Admin API (useful for debugging/dynamic config)
	admin :2019
	# Automatic HTTPS configuration (can be disabled for local dev)
	auto_https off # Change to `disable_redirects` or remove for production with domain
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory # Use Let's Encrypt staging for testing
}

(site_common) {
	# Enable compression
	encode gzip zstd

	# Serve static files from the mapped volume
	@static {
		path /*
		not path /admin/* /images/*
	}
	file_server @static {
		root /srv/static_output
		index index.html index.htm
	}

	# Reverse proxy requests to the Admin Panel (FastAPI)
	reverse_proxy /admin/* http://admin_app:8000 {
		# header_up Host {http.request.host}
		# header_up X-Real-IP {http.request.remote}
		# header_up X-Forwarded-For {http.request.remote}
		# header_up X-Forwarded-Proto {http.request.scheme}
	}

	# Reverse proxy requests to MinIO for images
	# The path rewrite removes /images/ prefix before forwarding to MinIO
	# It expects the bucket name to be part of the path passed from MinIO client
	# e.g., request to /images/my-bucket/image.png -> proxy to minio:9000/my-bucket/image.png
	reverse_proxy /images/* http://minio:9000 {
		header_up Host {http.request.host} # Important for MinIO to know the host
		# header_up X-Real-IP {http.request.remote}
		# header_up X-Forwarded-For {http.request.remote}
		# header_up X-Forwarded-Proto {http.request.scheme}
	}

	# Basic logging
	log {
		output stdout
		format console
	}
}

{$CADDY_DOMAIN_NAME:80} {
	import site_common
}

# You can add other sites or configurations here if needed 