# Jinja2 Template Editor Architecture with Tiptap

## 1. Goals

- Enable users to visually edit articles with Jinja2 micro-templates (e.g., `{menu: ...}`, `{footer}`) using Tiptap.
- Ensure a single source of truth for all micro-template definitions (structure, parameters, description, template filename).
- Guarantee synchronization between the editor, generator, and template files.
- Provide extensibility and ease of maintenance.

---

## 2. Key Components

### 2.1. Micro-Template Registry (`shared/jinja_microtemplates.json`)

- **Contains:**
  - Key (micro-template ID, e.g., `menu`, `footer`, `vrezka1`)
  - Display name and description (for UI)
  - Type (block/inline)
  - List of parameters (name, type, description, default)
  - Template filename (e.g., `"template": "menu.html"`)
- **Used by:**
  - Frontend (Tiptap editor, slash menu, hints)
  - Backend (validation, documentation generation, static site generator)

**Example:**
```json
{
  "menu": {
    "displayName": "Menu",
    "description": "Main navigation menu",
    "type": "block",
    "attributes": {
      "type": { "type": "string", "default": "main", "description": "Menu type" }
    },
    "template": "menu.html"
  },
  "footer": {
    "displayName": "Footer",
    "description": "Page footer",
    "type": "block",
    "attributes": {},
    "template": "footer.html"
  }
}
```

---

### 2.2. Jinja2 Micro-Template Files (`generator/templates/microtemplates/`)

- Each micro-template is a separate Jinja2 file (e.g., `menu.html`, `footer.html`).
- Filenames are specified in the registry.
- Templates use parameters defined in the registry.
- CSS: either a shared file (`microtemplates.css`) or separate files per block.

---

### 2.3. Tiptap Integration

- Tiptap extensions for each micro-template are generated based on the registry.
- Slash menu and toolbar are built from the registry.
- Export to HTML: outputs placeholders like `{menu: ...}` or `{footer}`.
- Validation and hints are based on registry data.

---

### 2.4. Static Site Generator

- On generation:
  - Parses `content_html` from MongoDB.
  - Finds all micro-templates (by `{name: ...}` syntax).
  - For each, inserts the corresponding Jinja2 template from `generator/templates/microtemplates/`, passing parameters.
  - Renders the final page.
- Validation:
  - Script checks that each registry entry has a template file and that parameters match.

---

### 2.5. Documentation & Autogeneration

- Documentation for micro-templates can be autogenerated from the registry.
- Optionally, generate Markdown help for editors and admins.

---

## 3. File Structure

```
shared/
  jinja_microtemplates.json      # Micro-template registry (single source of truth)
  __init__.py                    # Python export
  graphql-types/                 # TypeScript/JS export

generator/
  templates/
    article.html
    base.html
    microtemplates/
      menu.html
      footer.html
      vrezka1.html
  static/
    css/
      microtemplates.css

admin_app/
  frontend/
    src/
      tiptap/
        extensions/
          jinjaTag.ts           # Universal extension for micro-templates
        microtemplates.ts       # Imports registry, builds menu and commands
```

---

## 4. Data Flow

1. **Editing:** User inserts micro-templates via Tiptap (slash menu, buttons).
2. **Saving:** `editor.getHTML()` is saved to MongoDB as `content_html`.
3. **Generation:** Generator fetches `content_html`, parses micro-templates, inserts corresponding Jinja2 templates.
4. **Rendering:** Jinja2 renders the final page with parameter substitution.

---

## 5. Validation & Maintenance

- Validator script checks correspondence between registry and templates.
- Adding a new micro-template:
  1. Add entry to `shared/jinja_microtemplates.json`.
  2. Create template in `generator/templates/microtemplates/`.
  3. (Optional) Add CSS.
  4. Run validation.

---

## 6. Advantages

- **Single source of truth** — no desynchronization.
- **Flexibility** — easy to add new blocks.
- **Ease of maintenance** — everything is explicitly linked via template name.
- **Extensibility** — can add documentation generation, validation, new block types.

---

## 7. Next Steps

1. Create/fill `shared/jinja_microtemplates.json`.
2. Implement universal Tiptap extension using the registry.
3. Implement parser and generator for template substitution.
4. Add validator script.
5. Document the process for adding new micro-templates. 